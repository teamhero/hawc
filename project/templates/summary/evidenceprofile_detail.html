{% extends 'portal.html' %}
{% load keyvalue %}
{% load evidenceprofile_scenario_effect %}
{% load evidenceprofile_scenario_confidencefactorset %}

{% block title %}
	{{assessment}} | Evidence Profile Table | {{object}} | HAWC
{% endblock title %}

{% block breadcrumbs %}
  <li><a href="{% url 'assessment:detail' pk=assessment.pk %}">{{ assessment }}</a><span class="divider">/</span></li>
  <li><a href="{% url 'summary:visualization_list' assessment.pk %}">Visualizations</a><span class="divider">/</span></li>
  {% if crud == "Read" %}
	 <li class="active">{{object}}<span class="divider">/</span></li>
  {% else %}
	 <!-- Update or delete -->
  	<li><a href="{{object.get_absolute_url}}">{{object}}</a><span class="divider">/</span></li>
	 <li class="active">{{crud}}<span class="divider">/</span></li>
  {% endif %}
{% endblock breadcrumbs %}

{% block content %}
  <h1>
    {{object}}
    <div class="btn-group pull-right">
      <a class="btn btn-primary dropdown-toggle" data-toggle="dropdown">Actions
        <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
        <li><a href="{% url 'summary:evidence_profile-list' %}?assessment_id={{assessment.id}}&id={{object.id}}&format=json">Download JSON Object</a></li>
        {% if obj_perms.edit %}
          <li class="divider"></li>
          <li><a href="{% url "summary:evidenceprofile_update" assessment.pk object.slug %}">Edit Report Details</a></li>
          <li><a href="{% url "summary:evidenceprofile_delete" assessment.pk object.slug %}">Delete Report</a></li>
        {% endif %}
      </ul>
    </div>
  </h1>

  {% block evidence_profile_table %}
    <table id="evidenceProfileTable">
      <tr class="headerRow">
        <td colspan="2" style="width:12.5%;">Outcome</td>
        <td style="width:12.5%;">Studies</td>
        <td style="width:12.5%;">Factors That <em>Increase</em> Confidence</td>
        <td style="width:12.5%;">Factors That <em>Decrease</em> Confidence</td>
        <td style="width:12.5%; font-size:0.9em;">Summary of Findings and Confidence Judgement for Individual Outcome</td>
        <td style="width:12.5%;">Within-Stream Confidence Judgement</td>
        <td style="width:12.5%;">Inference Across Streams</td>
        <td style="width:12.5%;">Across-Stream Confidence Judgement</td>
      </tr>

      <tr class="bodyRow">
        <td colspan="7" class="bodyCellStreamTitle">
          {% if tableBodyRows > 1 %}
            {% with stream=evidenceProfile.streams|first %}
              {% if stream.stream_title == "" %}
                Stream Has No Title
              {% else %}
                {{stream.stream_title|safe}}
              {% endif %}
            {% endwith %}
          {% else %}
            No Streams In Evidence Profile
          {% endif %}
        </td>
        <td rowspan="{{tableBodyRows|safe}}">
          {{evidenceProfile.cross_stream_inferences|safe}}
        </td>
        <td rowspan="{{tableBodyRows|safe}}">
          {{evidenceProfile.cross_stream_confidence_judgement|safe}}
        </td>
      </tr>

      {% for stream in evidenceProfile.streams %}
        {% if forloop.counter > 1 %}
          <tr class="bodyRow">
            <td colspan="7" class="bodyCellStreamTitle">
              {% if stream.stream_title == "" %}
                Stream Has No Title
              {% else %}
                {{stream.stream_title|safe}}
              {% endif %}
            </td>
          </tr>
        {% endif %}

        {% if stream.scenarios %}
          {% for scenario in stream.scenarios %}
            <tr class="bodyRow">
              <td rowspan="{{scenarioRows|keyvalue:scenario.pk}}">
                {% if scenario.scenario_name == "" %}
                  Scenario Has No Name
                {% else %}
                  {{scenario.scenario_name|safe}}
                {% endif %}
              </td>

              {% if scenario.studies|length > 0 %}
                {% with effect=scenario.studies|first %}
                  <td>
                      {{effect.name|safe}}
                  </td>
                  {% evidenceprofile_scenario_effect effect %}
                {% endwith %}
              {% else %}
                <td colspan="6">No Studies</td>
              {% endif %}

              {% evidenceprofile_scenario_confidencefactorset scenario.confidencefactors_increase scenarioRows|keyvalue:scenario.pk %}
              {% evidenceprofile_scenario_confidencefactorset scenario.confidencefactors_decrease scenarioRows|keyvalue:scenario.pk %}

              <td rowspan="{{scenarioRows|keyvalue:scenario.pk}}">
                {{scenario.outcome|safe}}
              </td>

              {% if forloop.first %}
                <td rowspan="{{streamRows|keyvalue:stream.pk}}">
                  {{stream.confidence_judgement|safe}}
                </td>
              {% endif %}
            </tr>

            {% for effect in scenario.studies %}
              {% if forloop.counter > 1 %}
                <tr class="bodyRow">
                  <td>{{effect.name|safe}}</td>
                  {% evidenceprofile_scenario_effect effect %}
                </tr>
              {% endif %}
            {% endfor %}
          {% endfor %}
        {% else %}
          <tr class="bodyRow">
            <td>No Scenarios In Stream</td>
            <td rowspan="{{streamRows|keyvalue:stream.pk}}">
              {{stream.confidence_judgement|safe}}
            </td>
          </tr>
        {% endif %}
      {% endfor %}
    </table>
    <div id="caption">{{evidenceProfile.caption|safe}}</div>
  {% endblock evidence_profile_table %}
{% endblock content %}

{% block extrajs %}
  <style>
    #evidenceProfileTable {
      font-size: 0.9em;
    }

    tr.headerRow td {
      font-weight: bold;
      text-align: center;
      vertical-align: bottom;
      padding-bottom: 0;
      margin-bottom: 0;
    }

    tr.bodyRow td {
      font-weight: normal;
      text-align: left;
      vertical-align: top;
      padding: 0 3px 0 3px;
    }

    td.bodyCellStreamTitle {
      background: #DDDDDD;
    }
  </style>
{% endblock extrajs %}
