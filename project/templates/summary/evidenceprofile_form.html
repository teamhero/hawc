{% extends 'portal.html' %}

{% load crispy_forms_tags %}
{% load add_class %}
{% load selectable_tags %}

{% block title %}
  {{assessment}} | {{crud}} Evidence Profile | HAWC
{% endblock %}

{% block breadcrumbs %}
  <li><a href="{{assessment.get_absolute_url}}">{{assessment}}</a><span class="divider">/</span></li>
  <li><a href="{% url 'summary:visualization_list' assessment.id %}">Visualizations</a><span class="divider">/</span></li>
  {% if crud == "Update" %}
    <li><a href="{{object.get_absolute_url}}">{{object}}</a><span class="divider">/</span></li>
  {% endif %}
  <li class="active">{{crud}}<span class="divider">/</span></li>
{% endblock %}


{% block content %}
  {% crispy form %}

  {% include "summary/_smartTagEditModal.html" with form=smart_tag_form only %}
{% endblock %}

{% block extrajs %}
  {{ smart_tag_form.media }}

  <script type="text/javascript">
    // Run the assessmentStartup() method for this app
    window.app.assessmentStartup(
      function(assessment) {
        {% if crud == "Create" %}
          // This object is being created, build the 'slug' field based on the 'title' field by updating the slug every
          // time the title is changed (50 character maximum for the slug)
          $('#id_title').on(
            'keyup'
            ,function() {
              $('#id_slug').val(URLify($(this).val(), 50));
            }
          );
        {% endif %}

        // Start up and initialize the Smart Tags JavaScript object
        window.app.smartTagsStartup(
          function(smartTags) {
            // Create a "smart tag" textarea editor for the 'caption' field
            new smartTags.SmartTagEditor($('#id_caption,#id_confidence_judgement_explanation'), {submitEl: '#evidenceProfileForm'});
          }
        );

        // Start up and initialize the Evidence Profile JavaScript object
        window.app.evidenceProfileStartup(
          function(evidenceProfile) {

            // Configure the EvidenceProfile object
            evidenceProfile.EvidenceProfile.configure(
              {
                form: {
                  id: "evidenceProfileForm",
                  captionDiv: "div_id_caption",
                  actionsClass: "form-actions",
                  confidenceJudgements: evidenceProfile.Library.setConfidenceJudgements({{confidence_judgements|safe}}),
                },
                crossStreamInferences: {
                  divId: "div_id_inferences",
                  tableId: "table_inferences",
                  addButtonId: "add_inference_row",
                  rowIdPrefix: "row_inference",
                  fieldPrefix: "inference",
                  buttonSetPrefix: "btn_inference",
                  buttonSetRegEx: new RegExp("^btn_inference_(\\d+)_(moveup|movedown|remove)$", "gi"),
                },
                streams: {
                  divId: "div_id_streams",
                  tableId: "table_id_streams",
                  addButtonId: "add_stream_row",
                  streamDivIdPrefix: "div_id_stream",
                  fieldIdPrefix: "stream",
                  buttonSetPrefix: "btn_stream",
                  buttonSetRegEx: new RegExp("^btn_stream_(\\d+)_(moveup|movedown|remove)$", "gi"),
                  streamTypes: evidenceProfile.Library.setStreamTypes({{stream_types|safe}}),
                }
              },
              {{evidenceProfile|safe}}
            );

            // Add an <hr /> tag just below the "caption" field in the form
            evidenceProfile.Library.addHRTag("caption", "after");

            /*
            // Create the Evidence Profile Streams formset and add it to the Evidence Profile form
            evidenceProfile.EvidenceProfile.buildEvidenceProfileStreamsFormset();
            */

            // Create the Cross-Stream Inferences formset and add it to the Evidence Profile form
            evidenceProfile.EvidenceProfile.buildCrossStreamInferencesFormset();
          }
        );
      }
    );
  </script>
{% endblock extrajs %}
